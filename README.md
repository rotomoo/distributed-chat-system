# Distributed Chat System

## ëª©ì°¨

[ì‚¬ìš©ë²•](#ì‚¬ìš©ë²•)  
[ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­](#ê¸°ëŠ¥-ìš”êµ¬ì‚¬í•­)  
[ê°œëµì  ê·œëª¨ ì¶”ì •](#ê°œëµì -ê·œëª¨-ì¶”ì •)  
[ì•„í‚¤í…ì²˜ ì„¤ê³„](#ì•„í‚¤í…ì²˜-ì„¤ê³„)  
[ê¸°ëŠ¥ ëª©ë¡](#ê¸°ëŠ¥-ëª©ë¡)  
[DB ì„¤ê³„](#DB-ì„¤ê³„)  
[ì±„íŒ… ë©”ì‹œì§€ íë¦„](#ì±„íŒ…-ë©”ì‹œì§€-íë¦„)  
[ëª¨ë“ˆ ê³„ì¸µ](#ëª¨ë“ˆ-ê³„ì¸µ)  
[ìºì‹œ ê³„ì¸µ](#ìºì‹œ-ê³„ì¸µ)  
[ëª¨ë‹ˆí„°ë§](#ëª¨ë‹ˆí„°ë§)

## ì‚¬ìš©ë²•

## ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

- íŒ€ ê¸°ëŠ¥
- ì‹¤ì‹œê°„ DM(Direct Message), ì±„ë„ ì±„íŒ… ê¸°ëŠ¥
- ì‹¤ì‹œê°„ íŒ€ ì‚¬ìš©ì ì ‘ì†ìƒíƒœ í‘œì‹œ ê¸°ëŠ¥
- DAU(Daily Active User) 50,000,000ëª… ì§€ì› ì‹œìŠ¤í…œ
- ë©˜ì…˜ ê¸°ëŠ¥
- ì±„íŒ… ë©”ì‹œì§€ ì²¨ë¶€íŒŒì¼(ì´ë¯¸ì§€) ì§€ì› ê¸°ëŠ¥
- ì±„íŒ… ë©”ì‹œì§€ ì´ëª¨í‹°ì½˜ ë°˜ì‘ ê¸°ëŠ¥
- ì±„íŒ… ë©”ì‹œì§€ ëŒ“ê¸€ ê¸°ëŠ¥
- ì±„íŒ… ë©”ì‹œì§€ ì¢…ë‹¨ ê°„ ì•”í˜¸í™” í•„ìš”
- ëª¨ë“  ì±„íŒ… ì´ë ¥ 10ë…„ ë³´ê´€
- ë‹¤ì–‘í•œ ë‹¨ë§ ë™ì‹œ ì ‘ì† ì§€ì›
- í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥

## ê°œëµì  ê·œëª¨ ì¶”ì •

**ë°ì´í„° ì €ì¥ ì „ëµ**

- Mysql

  ìœ ì €, ì±„ë„, ì„¤ì • ë°ì´í„° ì €ì¥


- MongoDB

  í…ìŠ¤íŠ¸ ë©”ì‹œì§€, ë©”íƒ€ë°ì´í„°, ì´ëª¨í‹°ì½˜ ë°˜ì‘, ëŒ“ê¸€ ì €ì¥

  ì˜ˆì‹œ

    ```json
    {
      "chatRoomId": "room_12345",
      "participants": ["user_001", "user_002", "user_003"],
      "messages": [
        {
          "messageId": "msg_001",
          "userId": "user_001",
          "content": "ì•ˆë…•í•˜ì„¸ìš”!",
          "timestamp": "2024-11-18T10:30:00Z",
          "reactions": {"ğŸ‘": 10, "â¤ï¸": 5},
          "comments": [
            {
              "commentId": "cmt_001",
              "userId": "user_002",
              "content": "ë°˜ê°€ì›Œìš”!",
              "timestamp": "2024-11-18T10:35:00Z"
            }
          ],
          "attachments": [
            {
              "type": "image",
              "url": "https://s3.amazonaws.com/bucket/file_001.jpg"
            }
          ]
        }
      ]
    }
    ```


- S3

  ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼ì„ ì €ì¥í•˜ê³ , íŒŒì¼ URLë§Œ MongoDBì— ì €ì¥.

<br>

**ì €ì¥ì†Œ ìš”êµ¬ëŸ‰**

- DAU (Daily Active Users): 50,000,000ëª…
- 1ì¸ë‹¹ ì¼ì¼ í‰ê·  ë©”ì‹œì§€ ì „ì†¡ ìˆ˜: 20ê±´
- ìµœëŒ€ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ í¬ê¸°: 200KB (í•œê¸€, 100,000ì ì œí•œ)
- ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼ ë¹„ìœ¨: 20%
- í‰ê·  ì´ë¯¸ì§€ í¬ê¸°: 200KB

- ì—°ê°„ ë©”ì‹œì§€ í¬ê¸° = 50,000,000 * 20ê±´ X 200KB * 365ì¼ = 73PB / year (73,000TB / year)
- ì—°ê°„ ì´ë¯¸ì§€ í¬ê¸° = 50,000,000 * 20ê±´ * 20% * 200KB * 365ì¼ = 14.6PB / year (14,600TB / year)

- 10ë…„ê°„ MongoDB ì €ì¥ì†Œ ìš”êµ¬ëŸ‰ 730 PB
    - ë¶„ì‚°(ìƒ¤ë”©)

- 10ë…„ê°„ S3 ì €ì¥ì†Œ ìš”êµ¬ëŸ‰ = 146 PB
    - S3 ë¶„ì‚°

<br>

**ì±„íŒ…ì„œë²„ ë©”ëª¨ë¦¬ ìš”êµ¬ëŸ‰**

- ë™ì‹œ ì ‘ì†ì: 1,000,000ëª…
- ì ‘ì†ë‹¹ ì„œë²„ ë©”ëª¨ë¦¬ : 10KB
- ì±„íŒ…ì„œë²„ ë©”ëª¨ë¦¬ ìš”êµ¬ëŸ‰ : 10GB
    - íŠ¸ë˜í”½ ë¶„ì‚° í•„ìš” : ì±„íŒ… ì„œë²„ ë¶„ì‚°
        - SPOF ë°©ì§€ : ê°€ìš©ì„± í™•ë³´

<br>

## ì•„í‚¤í…ì²˜ ì„¤ê³„

## ê¸°ëŠ¥ ëª©ë¡

**client-api ì„œë²„**

- íšŒì›ê°€ì…
- ë¡œê·¸ì¸
- íŒ€ ëª©ë¡ ì¡°íšŒ
- íŒ€ ì°¸ê°€
- íŒ€ ì•Œë¦¼ ìŒì†Œê±°
- ë©˜ì…˜ íšŒì› ëª©ë¡ ì¡°íšŒ

<br>

**connection-status ì„œë²„**

- íŒ€ ì‚¬ìš©ì ì ‘ì†ìƒíƒœ ëª©ë¡ ì¡°íšŒ

<br>

**chatting ì„œë²„**

- ë©”ì‹œì§€ ì „ì†¡
- ë©”ì‹œì§€ ìˆ˜ì‹ 

<br>

**notification ì„œë²„**

- ë¯¸ìˆ˜ì‹  ë©”ì‹œì§€ í‘¸ì‹œ

## DB ì„¤ê³„

**Mysql**

- ë„ë©”ì¸ ëª¨ë¸ ë¶„ì„
  ![rdb_domain](./image/rdb_domain.png)
- í…Œì´ë¸” ì„¤ê³„
  ![rdb_table](./image/rdb_table.png)
- ë¶„ì‚° ì²˜ë¦¬
    - Replication : ì£¼(master) - ì“°ê¸° ì—°ì‚°, ë¶€(slave) - ì½ê¸° ì—°ì‚°
    - ìë™ Failover : ê°€ìš©ì„± í™•ë³´

<br>

**MongoDB**

- ì»¬ë ‰ì…˜ ì„¤ê³„
- ë¶„ì‚° ì²˜ë¦¬
    - ìƒ¤ë”© : ìƒ¤ë“œ í‚¤

## ì±„íŒ… ë©”ì‹œì§€ íë¦„

## ëª¨ë“ˆ ê³„ì¸µ

- **distributed-chat-system**
    - ğŸ“‚ **module**
        - ğŸ“‚ **common**
            - ğŸ“ distributed-chat-system-api-base
            - ğŸ“ distributed-chat-system-common
            - ğŸ“ distributed-chat-system-web-socket-base
        - ğŸ“‚ **database**
            - ğŸ“ distributed-chat-system-mongodb
            - ğŸ“ distributed-chat-system-mysql
        - ğŸ“‚ **project**
            - ğŸ“ distributed-chat-system-chatting
            - ğŸ“ distributed-chat-system-client-api
            - ğŸ“ distributed-chat-system-connection-status
            - ğŸ“ distributed-chat-system-notification

<br>

~~~
distributed-chat-system
  â””â”€â”€ module
      â”œâ”€â”€ common    # ê³µí†µ ê¸°ëŠ¥ ëª¨ë“ˆ
      â”œâ”€â”€ database  # ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ëª¨ë“ˆ
      â””â”€â”€ project   # ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ë ¨ ëª¨ë“ˆ
~~~

## ìºì‹œ ê³„ì¸µ

**Redis [Look Aside + Write Around ì „ëµ](https://rotomoo.tistory.com/99)**
![caching-strategies](./image/caching-strategies.png)
**CDN ì ìš©**

## ëª¨ë‹ˆí„°ë§

**Grafana**